<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taglich | ADHD Friendly Task Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons for calm, rounded iconography -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        /* Custom Calm Theme Overrides */
        body {
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0; /* Slate 200 */
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        /* Smooth transitions for everything */
        * {
            transition: all 0.2s ease-in-out;
        }

        /* Hide scrollbar for cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a;
        }
        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        /* Specific utility to hide scrollbar but allow scrolling if needed */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Custom Input Styles */
        input, textarea, select {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            color: #f1f5f9;
            border-radius: 0.75rem;
            width: 100%; /* Ensure full width */
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #2dd4bf; /* Teal 400 */
            box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
        }

        /* Soft Button Styles */
        .btn-primary {
            background-color: #2dd4bf; /* Teal 400 */
            color: #0f172a;
            font-weight: 600;
        }
        .btn-primary:hover {
            background-color: #14b8a6; /* Teal 500 */
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            background-color: #334155; /* Slate 700 */
            color: #f1f5f9;
        }
        .btn-secondary:hover {
            background-color: #475569; /* Slate 600 */
        }

        /* Modal Backdrop */
        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
        }

        /* Progress Bar Animation */
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        .progress-active {
            animation: pulse-soft 3s infinite;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="h-[100dvh] min-h-[100dvh] flex flex-col items-center justify-center relative overflow-hidden bg-gradient-to-br from-slate-900 via-slate-900 to-slate-800">

    <!-- NEW: Loading View -->
    <div id="loading-view" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-900">
        <i class="ph-duotone ph-brain text-6xl text-teal-400 animate-pulse mb-4"></i>
        <p class="text-slate-400 text-sm font-medium tracking-wider">LOADING TAGLICH...</p>
    </div>

    <!-- Auth View -->
    <div id="auth-view" class="flex flex-col items-center justify-center w-full max-w-md p-6 text-center hidden z-10">
        <div class="mb-8 p-4 bg-slate-800 rounded-2xl shadow-xl">
            <i class="ph ph-brain text-6xl text-teal-400"></i>
        </div>
        <h1 class="text-3xl font-bold mb-2 tracking-tight">Taglich</h1>
        <p class="text-slate-400 mb-8">A calm space to manage your day.</p>
        <button id="login-btn" class="btn-primary py-3 px-8 rounded-xl text-lg flex items-center gap-3 shadow-lg shadow-teal-900/50">
            <i class="ph-bold ph-google-logo"></i>
            Sign in with Google
        </button>
    </div>

    <!-- App View -->
    <div id="app-view" class="w-full h-[100dvh] md:h-[90vh] md:max-h-[850px] md:rounded-3xl flex flex-col hidden max-w-lg mx-auto bg-slate-900 shadow-2xl relative border-0 md:border md:border-slate-800 overflow-hidden">
        
        <!-- Header -->
        <header class="p-6 flex justify-between items-center bg-slate-900/90 backdrop-blur-md z-10 sticky top-0 border-b border-slate-800/50">
            <h1 class="text-xl font-bold text-teal-400 flex items-center gap-2">
                <i class="ph-fill ph-brain"></i> Taglich
            </h1>
            <div class="flex gap-4 items-center">
                <!-- UPDATED: Notification Permission Button (Only visible if needed) -->
                <button id="enable-notif-btn" class="text-rose-400 hover:text-rose-300 transition-colors hidden flex items-center gap-1 bg-rose-400/10 px-3 py-1.5 rounded-full border border-rose-400/20" title="Enable Notifications" onclick="requestNotificationPermission()">
                    <i class="ph-bold ph-bell-slash text-lg animate-pulse"></i>
                    <span class="text-xs font-semibold">Enable</span>
                </button>
                <button id="logout-btn" class="text-slate-500 hover:text-slate-300 text-sm">Sign Out</button>
            </div>
        </header>

        <!-- Tabs Navigation -->
        <div class="flex justify-center gap-2 px-6 py-4 bg-slate-900">
            <button id="tab-focus-btn" class="flex-1 py-2 rounded-lg font-medium bg-teal-400/10 text-teal-400 border border-teal-400/20 transition-colors" onclick="switchTab('focus')">
                Focus
            </button>
            <button id="tab-manage-btn" class="flex-1 py-2 rounded-lg font-medium text-slate-400 hover:bg-slate-800 transition-colors" onclick="switchTab('manage')">
                Manage
            </button>
        </div>

        <!-- MAIN CONTENT AREA -->
        <main class="flex-1 overflow-hidden relative flex flex-col">
            
            <!-- TAB 1: FOCUS MODE -->
            <div id="tab-focus" class="h-full w-full flex flex-col p-6 fade-in overflow-y-auto no-scrollbar">
                
                <!-- Empty State -->
                <div id="focus-empty" class="hidden h-full flex flex-col items-center justify-center text-center">
                    <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mb-6">
                        <i class="ph-duotone ph-clipboard-text text-4xl text-teal-400"></i>
                    </div>
                    <h2 class="text-2xl font-semibold mb-2">No tasks yet</h2>
                    <p class="text-slate-400 max-w-xs mb-8">Clear mind, clean slate. Add a task to get started.</p>
                    
                    <button onclick="openTaskModal()" class="btn-primary py-3 px-6 rounded-xl font-medium shadow-lg shadow-teal-900/20 flex items-center gap-2">
                        <i class="ph-bold ph-plus"></i> Add Task
                    </button>
                </div>

                <!-- Active Task State -->
                <div id="focus-content" class="flex flex-col min-h-full justify-between py-4 hidden">
                    
                    <!-- Top: Quote & Time -->
                    <div class="text-center space-y-6">
                        <div id="motivational-quote-container" class="bg-slate-800/50 p-4 rounded-xl border border-slate-700/50">
                            <p id="motivational-text" class="text-slate-300 italic font-medium">"One step at a time."</p>
                        </div>
                        
                        <!-- Visual Time Progress -->
                        <div class="relative pt-6">
                            <div class="flex justify-between text-xs text-slate-500 mb-2 font-mono uppercase tracking-wider">
                                <span>Progress</span>
                                <span id="time-remaining">00:00 left</span>
                            </div>
                            <div class="h-4 w-full bg-slate-800 rounded-full overflow-hidden">
                                <div id="progress-bar" class="h-full bg-gradient-to-r from-teal-500 to-emerald-400 w-0 progress-active transition-all duration-1000"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Center: Task Details -->
                    <div class="flex-1 flex flex-col items-center justify-center text-center my-8">
                        <span id="task-status-badge" class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-slate-800 text-slate-400 mb-4">
                            Upcoming
                        </span>
                        <h2 id="focus-title" class="text-3xl md:text-4xl font-bold text-white mb-4 leading-tight">
                            Write Project Report
                        </h2>
                        <div class="flex items-center gap-2 justify-center mb-2">
                            <i id="focus-repeat-icon" class="ph-bold ph-arrows-clockwise text-teal-400 hidden"></i>
                            <p id="focus-desc" class="text-lg text-slate-400 max-w-xs leading-relaxed">
                                Draft the introduction and methodology sections.
                            </p>
                        </div>
                    </div>

                    <!-- Bottom: Action Button -->
                    <div class="pb-6">
                        <button id="btn-start-task" class="w-full btn-primary py-5 rounded-2xl text-xl shadow-xl shadow-teal-900/20 flex items-center justify-center gap-3 hidden" onclick="handleTaskAction('start')">
                            <i class="ph-fill ph-play-circle text-2xl"></i>
                            Start Task
                        </button>
                        
                        <button id="btn-complete-task" class="w-full bg-slate-800 hover:bg-emerald-900/30 text-emerald-400 border-2 border-emerald-500/50 hover:border-emerald-500 py-5 rounded-2xl text-xl shadow-xl flex items-center justify-center gap-3 hidden transition-all" onclick="handleTaskAction('complete')">
                            <i class="ph-bold ph-check-circle text-2xl"></i>
                            Complete Task
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB 2: MANAGE MODE -->
            <div id="tab-manage" class="hidden h-full w-full overflow-y-auto p-6 pb-32 fade-in">
                
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-semibold">Your Tasks</h2>
                    
                    <!-- Updated Buttons Area -->
                    <div class="flex gap-3">
                        <button onclick="openSettingsModal()" class="text-sm text-slate-400 hover:text-white flex items-center gap-1 bg-slate-800 px-3 py-1.5 rounded-lg border border-slate-700">
                            <i class="ph-bold ph-gear"></i> Settings
                        </button>
                        <button onclick="openLinesModal()" class="text-sm text-teal-400 hover:text-teal-300 underline underline-offset-4">
                            Edit Motivations
                        </button>
                    </div>
                </div>

                <!-- Task List -->
                <div id="task-list" class="space-y-3">
                    <!-- Tasks injected via JS -->
                </div>

                <!-- Floating Add Button -->
                <button onclick="openTaskModal()" class="absolute bottom-24 right-6 w-14 h-14 bg-teal-500 hover:bg-teal-400 text-white rounded-full shadow-lg shadow-teal-900/50 flex items-center justify-center transition-transform hover:scale-105 z-50">
                    <i class="ph-bold ph-plus text-2xl"></i>
                </button>
            </div>
        </main>
    </div>

    <!-- MODAL: ADD/EDIT TASK -->
    <div id="task-modal" class="fixed inset-0 modal-backdrop hidden z-[60] flex items-end sm:items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl overflow-hidden transform transition-all">
            <div class="p-6">
                <h3 id="modal-title" class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i class="ph ph-list-plus text-teal-400"></i> New Task
                </h3>
                <form id="task-form" onsubmit="saveTask(event)">
                    <input type="hidden" id="task-id">
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Title</label>
                            <input type="text" id="input-title" required class="w-full p-3 text-lg" placeholder="e.g. Check emails">
                        </div>
                        
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Description (Optional)</label>
                            <textarea id="input-desc" class="w-full p-3 h-24 resize-none" placeholder="Break it down simply..."></textarea>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">Start Time</label>
                                <input type="datetime-local" id="input-time" required class="w-full p-3 text-sm">
                            </div>
                            <div>
                                <label class="block text-sm text-slate-400 mb-1">Duration (min)</label>
                                <input type="number" id="input-duration" required min="1" max="480" value="30" class="w-full p-3 text-sm">
                            </div>
                        </div>

                        <!-- Repeat Option Added -->
                        <div>
                            <label class="block text-sm text-slate-400 mb-1">Repeat</label>
                            <select id="input-repeat" class="w-full p-3 text-sm">
                                <option value="none">Don't repeat</option>
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                        </div>
                    </div>

                    <div class="mt-8 flex gap-3">
                        <button type="button" onclick="closeModal('task-modal')" class="flex-1 btn-secondary py-3 rounded-xl font-medium">Cancel</button>
                        <button type="submit" class="flex-1 btn-primary py-3 rounded-xl font-medium">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- MODAL: MANAGE MOTIVATIONS -->
    <div id="lines-modal" class="fixed inset-0 modal-backdrop hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl h-[80vh] flex flex-col">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold">Motivational Lines</h3>
                <button onclick="closeModal('lines-modal')" class="text-slate-500 hover:text-white"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div class="p-4 border-b border-slate-800 bg-slate-900/50">
                <form onsubmit="addLine(event)" class="flex gap-2">
                    <input type="text" id="new-line-input" required class="flex-1 p-3 text-sm" placeholder="Add a calming thought...">
                    <button type="submit" class="bg-teal-500/20 text-teal-400 hover:bg-teal-500/30 px-4 rounded-lg">
                        <i class="ph-bold ph-plus"></i>
                    </button>
                </form>
            </div>

            <div id="lines-list" class="flex-1 overflow-y-auto p-4 space-y-2">
                <!-- Lines injected here -->
            </div>
        </div>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="settings-modal" class="fixed inset-0 modal-backdrop hidden z-[60] flex items-center justify-center p-4">
        <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl flex flex-col overflow-hidden">
            <div class="p-6 border-b border-slate-800 flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center gap-2"><i class="ph-bold ph-gear text-teal-400"></i> Settings</h3>
                <button onclick="closeModal('settings-modal')" class="text-slate-500 hover:text-white"><i class="ph-bold ph-x"></i></button>
            </div>
            
            <div class="p-6 space-y-6">
                
                <!-- Notification Permission Status -->
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <h4 class="text-sm text-slate-400 uppercase tracking-wide font-bold mb-2">Notification Status</h4>
                    <div id="notif-status-display" class="flex items-center gap-2 text-sm font-medium">
                        <span class="w-3 h-3 rounded-full bg-slate-500"></span> Checking...
                    </div>
                    <button onclick="requestNotificationPermission()" class="mt-3 text-xs bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-lg border border-slate-600">
                        Request Permissions
                    </button>
                </div>

                <!-- Custom SFX -->
                <div>
                    <h4 class="text-sm text-slate-400 uppercase tracking-wide font-bold mb-3">Custom Sound Effect</h4>
                    <p class="text-xs text-slate-500 mb-3">Upload a short sound (MP3/WAV, max 300KB) to play when tasks complete. Syncs to your account.</p>
                    
                    <div class="flex gap-2 mb-3">
                        <input type="file" id="sfx-upload" accept="audio/*" class="text-xs text-slate-400 file:mr-2 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-xs file:font-semibold file:bg-teal-500/10 file:text-teal-400 hover:file:bg-teal-500/20" onchange="handleSfxUpload(this)">
                    </div>

                    <div id="current-sfx-status" class="text-xs text-slate-300 italic mb-4">Using: Default Calm Synth</div>

                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="playCurrentNotificationSound()" class="btn-secondary py-2 rounded-lg text-sm flex items-center justify-center gap-2">
                            <i class="ph-bold ph-speaker-high"></i> Test Sound
                        </button>
                        <button onclick="resetDefaultSfx()" class="bg-rose-500/10 text-rose-400 hover:bg-rose-500/20 py-2 rounded-lg text-sm border border-rose-500/20">
                            Reset to Default
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- FIREBASE & APP LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, setDoc, deleteDoc, doc, onSnapshot, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ⬇️ PASTE YOUR FIREBASE CONFIGURATION HERE ⬇️ ---
        const USER_CONFIG = {
            apiKey: "AIzaSyDyQre5q8jS36xw8Qvght3xVuPc0MxOqkg",
            authDomain: "taglich-b6a0e.firebaseapp.com",
            projectId: "taglich-b6a0e",
            storageBucket: "taglich-b6a0e.firebasestorage.app",
            messagingSenderId: "372214961644",
            appId: "1:372214961644:web:46da3066deb0baafbf1cc9",
            measurementId: "G-C7EG89S6T5"
        };
        // -------------------------------------------------------

        // If you want to use the preview environment here, it uses __firebase_config.
        // If you are deploying, it will use USER_CONFIG.
        let firebaseConfig;
        if (Object.keys(USER_CONFIG).length > 0) {
            firebaseConfig = USER_CONFIG;
        } else if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
        } else {
            console.error("No Firebase Config found. Please paste it in the code.");
            alert("Configuration Missing: Please paste your Firebase keys in the code!");
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'focus-app-default';
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null;
        let tasks = [];
        let motivationalLines = [];
        let currentFocusTask = null;
        let currentQuote = "";
        let progressInterval = null;
        let notificationInterval = null;
        let audioContext = null; // Global Audio Context
        let userSettings = {
            customSfx: null
        };

        // --- DOM ELEMENTS ---
        const views = { 
            auth: document.getElementById('auth-view'), 
            app: document.getElementById('app-view'),
            loading: document.getElementById('loading-view') 
        };
        const tabs = { focus: document.getElementById('tab-focus'), manage: document.getElementById('tab-manage') };
        const btns = { 
            tabFocus: document.getElementById('tab-focus-btn'), 
            tabManage: document.getElementById('tab-manage-btn') 
        };

        // --- AUDIO UNLOCKER ---
        // Browsers block audio until a user interacts with the page.
        // We capture the first click anywhere to initialize/resume audio.
        function unlockAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume().then(() => {
                    console.log("Audio Context Resumed");
                });
            }
        }
        document.addEventListener('click', unlockAudio);
        document.addEventListener('touchstart', unlockAudio);

        // --- AUTHENTICATION ---
        const initAuth = async () => {
            // Priority: Custom Token (Preview) -> Anonymous (Fallback)
            // Real Deployment: onAuthStateChanged handles persistence automatically
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (e) {
                    console.log("Custom token auth failed, falling back.");
                }
            } 
        };
        initAuth();

        onAuthStateChanged(auth, (user) => {
            // Hide loading screen once we have a definitive auth state
            views.loading.classList.add('hidden');

            currentUser = user;
            if (user) {
                views.auth.classList.add('hidden');
                views.app.classList.remove('hidden');
                views.app.classList.add('flex'); // Restore flex display
                initializeData(user.uid);
                startNotificationLoop();
                checkNotificationPermission();
            } else {
                views.auth.classList.remove('hidden');
                views.app.classList.add('hidden');
                views.app.classList.remove('flex');
            }
        });

        document.getElementById('login-btn').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // --- FIRESTORE DATA SYNC ---
        function initializeData(userId) {
            // Sync Tasks
            const tasksRef = collection(db, 'artifacts', appId, 'users', userId, 'tasks');
            onSnapshot(tasksRef, (snapshot) => {
                tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                // Client-side Sort: Ongoing first, then by scheduledTime
                tasks.sort((a, b) => {
                    if (a.status === 'ongoing' && b.status !== 'ongoing') return -1;
                    if (b.status === 'ongoing' && a.status !== 'ongoing') return 1;
                    return new Date(a.scheduledTime) - new Date(b.scheduledTime);
                });
                renderApp();
            }, (error) => console.error("Error fetching tasks:", error));

            // Sync Motivational Lines
            const linesRef = collection(db, 'artifacts', appId, 'users', userId, 'motivationalLines');
            onSnapshot(linesRef, (snapshot) => {
                motivationalLines = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                if (motivationalLines.length === 0) seedDefaultLines(userId);
                renderLinesManager();
            }, (error) => console.error("Error fetching lines:", error));

            // Sync Settings (Custom SFX)
            const settingsRef = doc(db, 'artifacts', appId, 'users', userId, 'settings', 'preferences');
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    userSettings = docSnap.data();
                    updateSettingsUI();
                }
            });
        }

        async function seedDefaultLines(userId) {
            const defaults = [
                "One thing at a time.", "You are doing enough.", "Breathe in, breathe out.", 
                "Progress, not perfection.", "Just start for 2 minutes."
            ];
            const batch = [];
            defaults.forEach(text => {
                addDoc(collection(db, 'artifacts', appId, 'users', userId, 'motivationalLines'), { text });
            });
        }

        // --- UI RENDERING ---
        window.renderApp = () => {
            renderFocusTab();
            renderManageTab();
        };

        // --- FOCUS TAB LOGIC ---
        function renderFocusTab() {
            // Find active task: Ongoing OR first upcoming, EXCLUDING completed
            const active = tasks.find(t => t.status === 'ongoing') || tasks.find(t => t.status === 'upcoming');
            
            // If the task changed, get a new random quote
            if (active?.id !== currentFocusTask?.id) {
                const quotes = motivationalLines.length ? motivationalLines : [{text: "You've got this."}];
                currentQuote = quotes[Math.floor(Math.random() * quotes.length)].text;
            }

            currentFocusTask = active;

            const emptyState = document.getElementById('focus-empty');
            const contentState = document.getElementById('focus-content');

            if (!active) {
                emptyState.classList.remove('hidden');
                contentState.classList.add('hidden');
                stopProgressTimer();
                return;
            }

            emptyState.classList.add('hidden');
            contentState.classList.remove('hidden');

            // Update Text
            document.getElementById('focus-title').textContent = active.title;
            document.getElementById('focus-desc').textContent = active.description || "No description provided.";
            document.getElementById('motivational-text').textContent = `"${currentQuote}"`;
            document.getElementById('task-status-badge').textContent = active.status;
            
            // Show repeat icon if recurring
            const repeatIcon = document.getElementById('focus-repeat-icon');
            if (active.repeatType && active.repeatType !== 'none') {
                repeatIcon.classList.remove('hidden');
            } else {
                repeatIcon.classList.add('hidden');
            }

            // Button Logic
            const btnStart = document.getElementById('btn-start-task');
            const btnComplete = document.getElementById('btn-complete-task');
            
            if (active.status === 'ongoing') {
                btnStart.classList.add('hidden');
                btnComplete.classList.remove('hidden');
                document.getElementById('task-status-badge').className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-teal-500/20 text-teal-400 mb-4 animate-pulse";
                startProgressTimer(active);
            } else {
                btnStart.classList.remove('hidden');
                btnComplete.classList.add('hidden');
                document.getElementById('task-status-badge').className = "px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide bg-slate-800 text-slate-400 mb-4";
                stopProgressTimer();
                updateProgressBar(0, active.duration);
            }
        }

        function startProgressTimer(task) {
            if (progressInterval) clearInterval(progressInterval);
            
            const update = () => {
                if (!task.startedAt) return; // Should allow manual start
                
                // Calculate elapsed time
                // Firestore timestamp conversion
                const startTime = task.startedAt.toDate ? task.startedAt.toDate() : new Date(task.startedAt);
                const now = new Date();
                const elapsedMinutes = (now - startTime) / 1000 / 60;
                
                updateProgressBar(elapsedMinutes, task.duration);
            };

            update(); // Immediate
            progressInterval = setInterval(update, 1000); // Update every second for smooth visual
        }

        function stopProgressTimer() {
            if (progressInterval) clearInterval(progressInterval);
            progressInterval = null;
        }

        function updateProgressBar(elapsed, total) {
            const percentage = Math.min(100, Math.max(0, (elapsed / total) * 100));
            const bar = document.getElementById('progress-bar');
            bar.style.width = `${percentage}%`;
            
            // Color shift based on completion
            if (percentage > 90) bar.className = 'h-full bg-emerald-400 w-0 progress-active transition-all duration-1000';
            else bar.className = 'h-full bg-gradient-to-r from-teal-500 to-emerald-400 w-0 progress-active transition-all duration-1000';

            const remaining = Math.max(0, Math.ceil(total - elapsed));
            document.getElementById('time-remaining').textContent = `${remaining}m left`;
        }

        // --- ACTION HANDLERS ---
        window.handleTaskAction = async (action) => {
            if (!currentFocusTask || !currentUser) return;

            const docRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', currentFocusTask.id);
            const task = tasks.find(t => t.id === currentFocusTask.id);

            try {
                if (action === 'start') {
                    await updateDoc(docRef, {
                        status: 'ongoing',
                        startedAt: serverTimestamp()
                    });
                } else if (action === 'complete') {
                    const repeat = task.repeatType || 'none';

                    if (repeat === 'none') {
                        // Standard completion
                        await updateDoc(docRef, {
                            status: 'completed',
                            completedAt: serverTimestamp()
                        });
                    } else {
                        // RESCHEDULE LOGIC
                        const oldDate = new Date(task.scheduledTime);
                        let newDate = new Date(oldDate);

                        if (repeat === 'daily') {
                            newDate.setDate(oldDate.getDate() + 1);
                        } else if (repeat === 'weekly') {
                            newDate.setDate(oldDate.getDate() + 7);
                        }

                        // Format back to string (YYYY-MM-DDTHH:MM)
                        const pad = n => n < 10 ? '0'+n : n;
                        const localIso = newDate.getFullYear() + '-' +
                            pad(newDate.getMonth() + 1) + '-' +
                            pad(newDate.getDate()) + 'T' +
                            pad(newDate.getHours()) + ':' +
                            pad(newDate.getMinutes());

                        await updateDoc(docRef, {
                            status: 'upcoming',
                            scheduledTime: localIso,
                            startedAt: null, // Clear these fields
                            completedAt: null
                        });
                    }

                    // Confetti or sound
                    playCurrentNotificationSound(); // UPDATED to use smart player
                }
            } catch (err) {
                console.error("Action Error:", err);
                if (err.code === 'permission-denied') {
                    alert("PERMISSION ERROR:\n\nYou need to update your Firestore Database Rules in the Firebase Console.\n\nSet them to allow read/write for authenticated users.");
                } else {
                    alert("Failed to update task. Error: " + err.message);
                }
            }
        };

        // --- MANAGE TAB LOGIC ---
        function renderManageTab() {
            const container = document.getElementById('task-list');
            container.innerHTML = '';

            // Filter out completed tasks from the manage list
            const activeTasks = tasks.filter(t => t.status !== 'completed');

            if (activeTasks.length === 0) {
                container.innerHTML = `<div class="text-center text-slate-500 py-10">No pending tasks. <br>Enjoy your day!</div>`;
                return;
            }

            activeTasks.forEach(task => {
                const date = new Date(task.scheduledTime);
                const timeString = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // Recurring icon logic
                const isRecurring = task.repeatType && task.repeatType !== 'none';
                const recurringIcon = isRecurring ? 
                    `<i class="ph-bold ph-arrows-clockwise text-teal-400/50 text-xs ml-1" title="Repeats ${task.repeatType}"></i>` : '';

                const el = document.createElement('div');
                el.className = `p-4 bg-slate-800 rounded-xl border border-slate-700 flex justify-between items-center group`;
                el.innerHTML = `
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs font-mono text-teal-400 bg-teal-400/10 px-2 py-0.5 rounded">${timeString}</span>
                            ${task.status === 'ongoing' ? '<span class="w-2 h-2 rounded-full bg-teal-400 animate-pulse"></span>' : ''}
                        </div>
                        <h3 class="font-medium text-slate-200 flex items-center">${task.title} ${recurringIcon}</h3>
                        <p class="text-xs text-slate-500 truncate max-w-[200px]">${task.description || ''}</p>
                    </div>
                    <div class="flex gap-2 opacity-100 sm:opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editTask('${task.id}')" class="p-2 text-slate-400 hover:text-white bg-slate-700 hover:bg-slate-600 rounded-lg">
                            <i class="ph-bold ph-pencil-simple"></i>
                        </button>
                        <button onclick="deleteTask('${task.id}')" class="p-2 text-slate-400 hover:text-rose-400 bg-slate-700 hover:bg-slate-600 rounded-lg">
                            <i class="ph-bold ph-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- TASK FORM HANDLING ---
        window.openTaskModal = () => {
            document.getElementById('task-form').reset();
            document.getElementById('task-id').value = '';
            document.getElementById('input-repeat').value = 'none'; // Default to none
            document.getElementById('modal-title').innerHTML = '<i class="ph ph-list-plus text-teal-400"></i> New Task';
            
            // Set default time to next 30 min block
            const now = new Date();
            now.setMinutes(Math.ceil(now.getMinutes() / 30) * 30);
            now.setSeconds(0);
            now.setMilliseconds(0);
            // Format for datetime-local: YYYY-MM-DDTHH:MM
            const iso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0, 16);
            document.getElementById('input-time').value = iso;
            
            document.getElementById('task-modal').classList.remove('hidden');
        };

        window.editTask = (id) => {
            const task = tasks.find(t => t.id === id);
            if (!task) return;
            
            document.getElementById('task-id').value = task.id;
            document.getElementById('input-title').value = task.title;
            document.getElementById('input-desc').value = task.description || '';
            document.getElementById('input-duration').value = task.duration;
            document.getElementById('input-time').value = task.scheduledTime; 
            document.getElementById('input-repeat').value = task.repeatType || 'none'; // Load repeat type
            document.getElementById('modal-title').innerHTML = '<i class="ph ph-pencil text-teal-400"></i> Edit Task';
            
            document.getElementById('task-modal').classList.remove('hidden');
        };

        window.saveTask = async (e) => {
            e.preventDefault();
            if (!currentUser) {
                alert("You must be signed in to add tasks.");
                return;
            }

            const id = document.getElementById('task-id').value;
            const data = {
                title: document.getElementById('input-title').value,
                description: document.getElementById('input-desc').value,
                scheduledTime: document.getElementById('input-time').value,
                duration: parseInt(document.getElementById('input-duration').value),
                repeatType: document.getElementById('input-repeat').value // Save repeat type
            };

            const collectionRef = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks');

            try {
                if (id) {
                    await updateDoc(doc(collectionRef, id), data);
                } else {
                    data.status = 'upcoming';
                    await addDoc(collectionRef, data);
                }
                closeModal('task-modal');
            } catch (err) {
                console.error("Save Error:", err);
                if (err.code === 'permission-denied') {
                    alert("PERMISSION ERROR:\n\nYou need to update your Firestore Database Rules in the Firebase Console.\n\nSet them to allow read/write for authenticated users.");
                } else {
                    alert("Failed to save task. Error: " + err.message);
                }
            }
        };

        window.deleteTask = async (id) => {
            if(confirm("Delete this task?")) {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'tasks', id));
                } catch (err) {
                    console.error("Delete Error:", err);
                    if (err.code === 'permission-denied') {
                         alert("PERMISSION ERROR:\n\nYou need to update your Firestore Database Rules in the Firebase Console.\n\nSet them to allow read/write for authenticated users.");
                    } else {
                        alert("Failed to delete. Error: " + err.message);
                    }
                }
            }
        };

        // --- MOTIVATIONAL LINES MANAGER ---
        window.openLinesModal = () => document.getElementById('lines-modal').classList.remove('hidden');
        
        function renderLinesManager() {
            const list = document.getElementById('lines-list');
            list.innerHTML = '';
            motivationalLines.forEach(line => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-slate-800 rounded-lg group";
                div.innerHTML = `
                    <span class="text-sm text-slate-300 italic">"${line.text}"</span>
                    <button onclick="deleteLine('${line.id}')" class="text-slate-600 hover:text-rose-400 opacity-0 group-hover:opacity-100 transition-opacity">
                        <i class="ph-bold ph-trash"></i>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        window.addLine = async (e) => {
            e.preventDefault();
            const input = document.getElementById('new-line-input');
            const text = input.value.trim();
            if (!text || !currentUser) {
                if(!currentUser) alert("Please sign in.");
                return;
            }
            
            try {
                await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'motivationalLines'), { text });
                input.value = '';
            } catch (err) {
                console.error("Add Line Error:", err);
                if (err.code === 'permission-denied') {
                    alert("PERMISSION ERROR:\n\nYou need to update your Firestore Database Rules in the Firebase Console.\n\nSet them to allow read/write for authenticated users.");
                } else {
                    alert("Failed to add line. Error: " + err.message);
                }
            }
        };

        window.deleteLine = async (id) => {
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'motivationalLines', id));
            } catch (err) {
                if (err.code === 'permission-denied') {
                    alert("PERMISSION ERROR: Check Firestore Rules.");
                } else {
                    alert("Failed to delete line.");
                }
            }
        };

        // --- SETTINGS & SFX MANAGER ---
        window.openSettingsModal = () => {
             document.getElementById('settings-modal').classList.remove('hidden');
             checkNotificationPermission(); // Update status text when opening
        };

        window.handleSfxUpload = (input) => {
            const file = input.files[0];
            if (!file) return;

            // Size check: 300KB limit to prevent Firestore bloating
            if (file.size > 300 * 1024) {
                alert("File too large! Please choose a sound file under 300KB.");
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Audio = e.target.result;
                try {
                    // Save to Firestore 'settings/preferences'
                    const settingsRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'preferences');
                    await setDoc(settingsRef, { customSfx: base64Audio }, { merge: true });
                    alert("Sound saved! It will now sync across your devices.");
                } catch (err) {
                    console.error("SFX Save Error:", err);
                    alert("Failed to save sound. Check permissions.");
                }
            };
            reader.readAsDataURL(file);
        };

        window.resetDefaultSfx = async () => {
            if(confirm("Reset to default beep sound?")) {
                try {
                    const settingsRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'preferences');
                    await updateDoc(settingsRef, { customSfx: null }); // Remove field
                    // Or deleteDoc(settingsRef) if preferences only has sfx
                } catch (err) {
                     console.error("Reset Error", err);
                }
            }
        };

        function updateSettingsUI() {
            const statusDiv = document.getElementById('current-sfx-status');
            if (userSettings && userSettings.customSfx) {
                statusDiv.innerHTML = `<span class="text-teal-400">✓ Using Custom Sound</span>`;
            } else {
                statusDiv.innerHTML = `Using: Default Calm Synth`;
            }
        }

        window.playCurrentNotificationSound = () => {
            if (userSettings && userSettings.customSfx) {
                // Play custom
                const audio = new Audio(userSettings.customSfx);
                audio.play().catch(e => console.log("Audio play error", e));
            } else {
                // Play default
                playGentleNotification(660, 'sine');
            }
        };

        // --- UTILS ---
        window.switchTab = (tabName) => {
            // UI Toggle
            Object.values(tabs).forEach(el => el.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');
            
            // Button Styles
            if (tabName === 'focus') {
                btns.tabFocus.className = "flex-1 py-2 rounded-lg font-medium bg-teal-400/10 text-teal-400 border border-teal-400/20 transition-colors";
                btns.tabManage.className = "flex-1 py-2 rounded-lg font-medium text-slate-400 hover:bg-slate-800 transition-colors";
            } else {
                btns.tabManage.className = "flex-1 py-2 rounded-lg font-medium bg-teal-400/10 text-teal-400 border border-teal-400/20 transition-colors";
                btns.tabFocus.className = "flex-1 py-2 rounded-lg font-medium text-slate-400 hover:bg-slate-800 transition-colors";
            }
        };

        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');

        // --- NOTIFICATIONS & SFX ---
        
        // Permission Handling
        window.checkNotificationPermission = () => {
            if (!("Notification" in window)) return;
            const btn = document.getElementById('enable-notif-btn');
            const statusDisplay = document.getElementById('notif-status-display');
            
            const permission = Notification.permission;

            // UI Text Update in Settings
            if (statusDisplay) {
                if (permission === 'granted') {
                    statusDisplay.innerHTML = `<span class="w-3 h-3 rounded-full bg-emerald-500"></span> Allowed`;
                } else if (permission === 'denied') {
                    statusDisplay.innerHTML = `<span class="w-3 h-3 rounded-full bg-rose-500"></span> Denied (Check Browser Settings)`;
                } else {
                    statusDisplay.innerHTML = `<span class="w-3 h-3 rounded-full bg-amber-500"></span> Default (Needs Permission)`;
                }
            }

            // Header Icon Logic
            if (permission === 'granted') {
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
            }
        }

        window.requestNotificationPermission = async () => {
            if (!("Notification" in window)) return;
            const permission = await Notification.requestPermission();
            checkNotificationPermission();
            if (permission === 'granted') {
                playCurrentNotificationSound();
            }
        }

        // DEFAULT SYNTH SOUND
        function playGentleNotification(freq = 440, type = 'sine') {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const ctx = audioContext;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            osc.type = type;
            osc.frequency.setValueAtTime(freq, ctx.currentTime);
            // Gentle slide up
            osc.frequency.exponentialRampToValueAtTime(freq * 1.5, ctx.currentTime + 1); 
            
            // Envelope (Soft Attack, Long Release)
            gain.gain.setValueAtTime(0, ctx.currentTime);
            gain.gain.linearRampToValueAtTime(0.05, ctx.currentTime + 0.1); // Low volume (gentle)
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 2);
            
            osc.start();
            osc.stop(ctx.currentTime + 2);
        }

        function startNotificationLoop() {
            if (!("Notification" in window)) return;
            
            // Initial check
            checkNotificationPermission();

            if (notificationInterval) clearInterval(notificationInterval);
            
            notificationInterval = setInterval(() => {
                const now = new Date();
                tasks.forEach(task => {
                    if (task.status !== 'upcoming') return;
                    
                    const taskTime = new Date(task.scheduledTime);
                    const diffMs = taskTime - now;
                    const diffMins = diffMs / 60000;

                    // Trigger exactly around 3 minutes (give or take the interval buffer)
                    if (diffMins > 2.8 && diffMins < 3.2 && !task.notified) {
                        // Mark locally to avoid spam (Note: In a full app, store this in DB or LocalStorage)
                        task.notified = true; 
                        
                        playCurrentNotificationSound(); // UPDATED
                        
                        if (Notification.permission === "granted") {
                            new Notification("Upcoming Task", {
                                body: `In 3 mins: ${task.title}`,
                                icon: "https://unpkg.com/@phosphor-icons/core/assets/brain.svg", // Placeholder icon logic
                                silent: true // We use our own gentle sound
                            });
                        }
                    }
                });
            }, 20000); // Check every 20 seconds
        }

    </script>
</body>
</html>
